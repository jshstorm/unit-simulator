# Unit Simulator 행동 규칙

이 문서는 시뮬레이션에서 유닛이 따르는 규칙과 알고리즘을 요약합니다.

## 시뮬레이션 루프
- `Program.Main`에서 매 프레임마다 적/아군 업데이트 → 렌더링 순서로 진행합니다.
- 최대 프레임 수(`Constants.MAX_FRAMES`)에 도달하거나 모든 웨이브를 처치하면 종료합니다.

## 유닛 속성
- 위치/속도/전방 벡터, 반지름(`Constants.UNIT_RADIUS`), 이동 속도, 회전 속도, 체력, 역할(근접/원거리), 진영(아군/적)을 가집니다.
- 체력: 아군 기본 HP `FRIENDLY_HP`가 적 HP `ENEMY_HP`의 약 10배입니다(현재 100 vs 10).
- 공격 사거리: 근접 `radius * 3`, 원거리 `radius * 6`.
- 공격 슬롯: 목표 주변에 8개, 가장 가까운 슬롯을 점유해 겹침을 방지합니다.

## 아군 분대 로직 (`SquadBehavior`)
- **랠리 & 대형**: 최초 적을 찾으면 랠리 포인트(목표에서 `Constants.RALLY_DISTANCE` 뒤쪽)를 잡고 리더가 이동, 나머지는 회전된 오프셋으로 대형 유지. 랠리 도착(`Constants.FORMATION_THRESHOLD`) 시 교전 모드 전환.
- **목표 지정**: 각 아군은 가장 가까운 살아있는 적을 타게팅. 슬롯 점유를 통해 공격 위치를 할당합니다.
- **교전 이동**: 공격 슬롯 위치를 목적지로 삼아 이동. `inAttackRange`(슬롯 거리 또는 적 중심 거리 ≤ 사거리)이면 이동을 멈추고 공격 쿨다운에 따라 피해를 줍니다.
- **개별 교전 전환**: 분대 전체 준비 상태와 무관하게, 적이 개별 아군 공격 사거리의 `1.5×` 이내로 진입하거나 이미 타겟이 묶여 있으면 즉시 교전 로직으로 전환해 이동을 중지하고 반격합니다.
- **회피/분리**: 이동 중 분리 벡터(`CalculateSeparationVector`)와 예측 회피 벡터(`AvoidanceSystem.PredictiveAvoidanceVector`)를 합산해 충돌과 겹침을 피합니다.
- **속도 규칙**: 이동 시 항상 기본 속도(`Speed`)로 등속 이동하며, 사거리/목표 임계(예: 3px, 사거리) 안에서만 정지합니다. 대형 유지에서도 추가 감속/가속 없이 등속을 사용합니다.
- **비전투 이동**: 적이 없으면 리더가 주 목표 지점으로 이동하고 나머지는 대형을 유지합니다.

## 적 분대 로직 (`EnemyBehavior`)
- **타겟팅 (거리+몰림 가중치)**: 각 적 유닛은 모든 살아있는 아군에 대해 `score = 거리 + (해당 아군에게 붙은 공격자 수 × crowdPenalty)`를 계산하고 가장 낮은 점수를 선택합니다. 이미 목표가 있어도 `TARGET_REEVALUATE_INTERVAL_FRAMES`마다 혹은 더 낮은 점수 목표가 `TARGET_SWITCH_MARGIN`보다 명확히 우수하면 갈아탑니다.
- 슬롯이 있으면 해당 슬롯 위치, 없으면 목표 기준 직교 방향으로 우회 위치를 목표로 이동합니다.
- 분리/회피는 아군과 동일한 시스템을 사용합니다.
- 공격: 적도 사거리 내에서 공격하며, 피해량은 `ENEMY_ATTACK_DAMAGE`를 사용하고 쿨다운은 `ATTACK_COOLDOWN`입니다.
- **슬롯 갱신 규칙**:
  - 목표가 바뀌거나 슬롯을 잃으면 즉시 다시 슬롯을 계산한다.
  - 현재 슬롯 위치 기준으로 `Constants.SLOT_REEVALUATE_DISTANCE` 이상 어긋나면 해당 슬롯을 재평가한다.
  - `Constants.SLOT_REEVALUATE_INTERVAL_FRAMES` 프레임마다 최소 한 번 슬롯을 다시 확인해 더 나은 슬롯이 있으면 교체한다.

## 충돌 예측 및 회피 (`AvoidanceSystem`)
- **정확한 충돌 예측**: 두 이동 원 사이의 첫 충돌 시각을 2차 방정식으로 계산(`MathUtils.TryGetFirstCollision`). 합반경은 `Constants.COLLISION_RADIUS_SCALE`로 축소한 값 사용.
- **위험 판단**: 충돌 시각이 `min((합반경*2)/speed, Constants.AVOIDANCE_MAX_LOOKAHEAD)` 이내이거나 최근접 시점/헤딩 튜브에서 합반경보다 좁으면 위험 목록에 추가합니다. 헤딩 검사는 이동 속도×`AVOIDANCE_MAX_LOOKAHEAD` 거리까지만 본다.
- **회피 방향 선택**: 현재 진행 방향을 기준으로 좌/우 회전(`Constants.AVOIDANCE_ANGLE_STEP`)을 스캔해 최초로 위험이 없는 방향을 선택, 가중치와 회피 목표를 설정합니다. 위험이 없으면 회피 벡터는 0입니다.
- **세그먼트 우회 경로**: 장애물을 만나면 `Constants.AVOIDANCE_SEGMENT_COUNT`에 따라 (우회 시작 → 측면 편향 → 병렬 이동 → 경로 복귀) 순서로 최대 3개 세그먼트를 생성해 고정된 우회 목표를 잇달아 따라가며, 세그먼트 거리/오프셋은 정의된 상수(`*_SEGMENT_*`)로 데이터 드리븐하게 조정합니다.

## 렌더링 (`Renderer`)
- 유닛, 슬롯, 전방 벡터, 최근 공격선, 회피 목표(우회 중일 때만)를 프레임 이미지로 그려 `output/frame_xxxx.png`로 저장합니다.

## 웨이브 관리 (`WaveManager`)
- 사전 정의된 좌표로 적 웨이브를 생성하고, 전 웨이브 처치 시 다음 웨이브를 스폰합니다. 최대 웨이브 수는 `Constants.MAX_WAVES`입니다.
